"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var utils = require("tns-core-modules/utils/utils");
var keystore_access_common_1 = require("./keystore-access.common");
var KeystoreAccess = (function (_super) {
    __extends(KeystoreAccess, _super);
    function KeystoreAccess() {
        var _this = _super.call(this) || this;
        _this.keyguardManager = utils.ad.getApplicationContext().getSystemService("keyguard");
        if (android.os.Build.VERSION.SDK_INT >= 23) {
            _this.fingerprintManager = utils.ad.getApplicationContext().getSystemService(android.hardware.fingerprint.FingerprintManager.class);
        }
        return _this;
    }
    KeystoreAccess.prototype.available = function () {
        var _this = this;
        this.stopListening();
        return new Promise(function (resolve, reject) {
            try {
                if (!_this.keyguardManager || !_this.keyguardManager.isKeyguardSecure()) {
                    resolve({
                        any: false,
                        customUI: true
                    });
                    return;
                }
                if (android.os.Build.VERSION.SDK_INT < 23) {
                    resolve({
                        any: false,
                        reason: "Your api version doesn't support fingerprint authentication",
                        customUI: true
                    });
                    return;
                }
                if (!_this.fingerprintManager.isHardwareDetected()) {
                    resolve({
                        any: false,
                        reason: "Device doesn't support fingerprint authentication",
                        customUI: true
                    });
                }
                else if (!_this.fingerprintManager.hasEnrolledFingerprints()) {
                    resolve({
                        any: false,
                        reason: "User hasn't enrolled any fingerprints to authenticate with",
                        customUI: true
                    });
                }
                else {
                    resolve({
                        any: true,
                        touch: true,
                        customUI: true
                    });
                }
            }
            catch (ex) {
                console.log("fingerprint-auth.available: " + ex);
                reject(ex);
            }
        });
    };
    KeystoreAccess.prototype.useCustomUI = function () {
        return true;
    };
    KeystoreAccess.prototype.storeDataWithFingerprint = function (keystoreKeyAlias, data, biometricMessage) {
        var _this = this;
        this.stopListening();
        return new Promise(function (resolve, reject) {
            _this.promiseResolve = resolve;
            _this.promiseReject = reject;
            try {
                _this.keystoreKeyAlias = keystoreKeyAlias;
                _this.data = data;
                _this.cipherInEncryptMode = true;
                _this.createKey(keystoreKeyAlias);
                _this.startListening();
            }
            catch (ex) {
                console.trace(ex);
                _this.deleteFingerprintEncryptedData(keystoreKeyAlias);
                reject({
                    code: keystore_access_common_1.ERROR_CODES.DEVELOPER_ERROR,
                    message: ex.message,
                });
            }
        });
    };
    KeystoreAccess.prototype.retrieveDataWithFingerprint = function (keystoreKeyAlias, biometricPromptMessage) {
        var _this = this;
        this.stopListening();
        return new Promise(function (resolve, reject) {
            _this.promiseResolve = resolve;
            _this.promiseReject = reject;
            try {
                _this.cipherInEncryptMode = false;
                _this.keystoreKeyAlias = keystoreKeyAlias;
                _this.startListening();
            }
            catch (ex) {
                _this.deleteFingerprintEncryptedData(keystoreKeyAlias);
                reject({
                    code: keystore_access_common_1.ERROR_CODES.DEVELOPER_ERROR,
                    message: ex.message,
                });
            }
        });
    };
    KeystoreAccess.prototype.fingerprintEncryptedDataExists = function (keystoreKeyAlias) {
        this.stopListening();
        this.keystoreKeyAlias = keystoreKeyAlias;
        var preferences = android.preference.PreferenceManager.getDefaultSharedPreferences(utils.ad.getApplicationContext());
        return preferences.contains(KeystoreAccess.name + this.keystoreKeyAlias);
    };
    KeystoreAccess.prototype.deleteFingerprintEncryptedData = function (keystoreKeyAlias) {
        this.stopListening();
        this.keystoreKeyAlias = keystoreKeyAlias;
        var preferences = android.preference.PreferenceManager.getDefaultSharedPreferences(utils.ad.getApplicationContext());
        preferences.edit().remove(KeystoreAccess.name + this.keystoreKeyAlias).apply();
    };
    KeystoreAccess.prototype.cleanup = function () {
        this.stopListening();
    };
    KeystoreAccess.prototype.createKey = function (keystoreKeyAlias) {
        try {
            this.keyStore = java.security.KeyStore.getInstance('AndroidKeyStore');
            this.keyStore.load(null);
            var keyGenerator = javax.crypto.KeyGenerator.getInstance(android.security.keystore.KeyProperties.KEY_ALGORITHM_AES, 'AndroidKeyStore');
            keyGenerator.init(new android.security.keystore.KeyGenParameterSpec.Builder(keystoreKeyAlias, android.security.keystore.KeyProperties.PURPOSE_ENCRYPT | android.security.keystore.KeyProperties.PURPOSE_DECRYPT)
                .setBlockModes([android.security.keystore.KeyProperties.BLOCK_MODE_CBC])
                .setUserAuthenticationRequired(true)
                .setUserAuthenticationValidityDurationSeconds(30)
                .setEncryptionPaddings([android.security.keystore.KeyProperties.ENCRYPTION_PADDING_PKCS7])
                .setKeySize(256)
                .build());
            keyGenerator.generateKey();
        }
        catch (ex) {
            console.trace(ex);
            this.promiseReject({
                code: keystore_access_common_1.ERROR_CODES.DEVELOPER_ERROR,
                message: ex.message,
            });
        }
    };
    KeystoreAccess.prototype.initCipher = function (mode, keystoreKeyAlias) {
        try {
            this.keyStore = java.security.KeyStore.getInstance('AndroidKeyStore');
            this.keyStore.load(null);
            var key = this.keyStore.getKey(keystoreKeyAlias, null);
            this.cipher = javax.crypto.Cipher.getInstance(android.security.keystore.KeyProperties.KEY_ALGORITHM_AES + "/" + android.security.keystore.KeyProperties.BLOCK_MODE_CBC + "/" + android.security.keystore.KeyProperties.ENCRYPTION_PADDING_PKCS7);
            this.cryptoObject = new android.hardware.fingerprint.FingerprintManager.CryptoObject(this.cipher);
            if (mode == javax.crypto.Cipher.ENCRYPT_MODE) {
                this.cipher.init(javax.crypto.Cipher.ENCRYPT_MODE, key);
            }
            else {
                if (key != null) {
                    var preferences = android.preference.PreferenceManager.getDefaultSharedPreferences(utils.ad.getApplicationContext());
                    var ivString = preferences.getString(KeystoreAccess.name + keystoreKeyAlias + "_encryption_iv", null);
                    if (ivString != null) {
                        var javaString = new java.lang.String(new java.lang.StringBuffer(ivString));
                        this.encryptionIv = android.util.Base64.decode(javaString.getBytes("UTF-8"), android.util.Base64.DEFAULT);
                        this.cipher.init(javax.crypto.Cipher.DECRYPT_MODE, key, new javax.crypto.spec.IvParameterSpec(this.encryptionIv));
                    }
                }
                else {
                    this.promiseReject({
                        code: keystore_access_common_1.ERROR_CODES.DEVELOPER_ERROR,
                        message: "IV not found while decrypting.",
                    });
                }
            }
        }
        catch (ex) {
            console.trace(ex);
            if (ex instanceof android.security.keystore.KeyPermanentlyInvalidatedException) {
                this.promiseReject({
                    code: keystore_access_common_1.ERROR_CODES.TAMPERED_WITH,
                    message: ex.getMessage(),
                });
            }
            else {
                this.promiseReject({
                    code: keystore_access_common_1.ERROR_CODES.DEVELOPER_ERROR,
                    message: ex.message,
                });
            }
        }
    };
    KeystoreAccess.prototype.tryEncrypt = function (secret) {
        try {
            this.encryptionIv = this.cipher.getIV();
            var encrypted = new java.lang.String(android.util.Base64.encode(this.cipher.doFinal(secret.getBytes("UTF-8")), android.util.Base64.DEFAULT), "UTF-8").toString();
            var preferences = android.preference.PreferenceManager.getDefaultSharedPreferences(utils.ad.getApplicationContext());
            var ivString = new java.lang.String(android.util.Base64.encode(this.encryptionIv, android.util.Base64.DEFAULT), "UTF-8").toString();
            preferences.edit().putString(KeystoreAccess.name + this.keystoreKeyAlias, encrypted).putString(KeystoreAccess.name + this.keystoreKeyAlias + "_encryption_iv", ivString).apply();
        }
        catch (ex) {
            console.trace(ex);
            this.promiseReject({
                code: keystore_access_common_1.ERROR_CODES.DEVELOPER_ERROR,
                message: ex.message,
            });
        }
    };
    KeystoreAccess.prototype.tryDecrypt = function () {
        try {
            var preferences = android.preference.PreferenceManager.getDefaultSharedPreferences(utils.ad.getApplicationContext());
            var sb = new java.lang.StringBuffer(preferences.getString(KeystoreAccess.name + this.keystoreKeyAlias, ""));
            var secret = android.util.Base64.decode(new java.lang.String(sb).getBytes("UTF-8"), android.util.Base64.DEFAULT);
            var decrypted = this.cipher.doFinal(secret);
            return new java.lang.String(decrypted, "UTF-8").toString();
        }
        catch (ex) {
            console.trace(ex);
            this.promiseReject({
                code: keystore_access_common_1.ERROR_CODES.DEVELOPER_ERROR,
                message: ex.message,
            });
        }
        return null;
    };
    KeystoreAccess.prototype.startListening = function () {
        this.cancellationSignal = new android.os.CancellationSignal();
        this.fingerprintManager.authenticate(this.cryptoObject, this.cancellationSignal, 0, this, null);
    };
    KeystoreAccess.prototype.stopListening = function () {
        if (this.cancellationSignal != null) {
            this.cancellationSignal.cancel();
            this.cancellationSignal = null;
        }
    };
    KeystoreAccess.prototype.onAuthenticationError = function (errorCode, errString) {
        this.promiseReject({
            code: keystore_access_common_1.ERROR_CODES.AUTHENTICATION_FAILED,
            message: errString,
            errorCode: errorCode
        });
    };
    KeystoreAccess.prototype.onAuthenticationHelp = function (helpCode, helpString) {
        if (helpCode == 1) {
            this.promiseReject({
                code: keystore_access_common_1.ERROR_CODES.RECOVERABLE_ERROR_FINGER_MUST_COVER_SENSOR,
                message: helpString
            });
        }
        else if (helpCode == 5) {
            this.promiseReject({
                code: keystore_access_common_1.ERROR_CODES.RECOVERABLE_ERROR_FINGER_MOVED_TO_FAST,
                message: helpString
            });
        }
        else {
            this.promiseReject({
                code: keystore_access_common_1.ERROR_CODES.RECOVERABLE_ERROR_BIOMETRICS_NOT_RECOGNIZED,
                message: helpString
            });
        }
    };
    KeystoreAccess.prototype.onAuthenticationSucceeded = function (result) {
        if (this.cipherInEncryptMode) {
            this.initCipher(javax.crypto.Cipher.ENCRYPT_MODE, this.keystoreKeyAlias);
            this.tryEncrypt(new java.lang.String(this.data));
            this.promiseResolve();
        }
        else {
            this.initCipher(javax.crypto.Cipher.DECRYPT_MODE, this.keystoreKeyAlias);
            var decrypted = this.tryDecrypt();
            console.log(decrypted);
            this.promiseResolve(decrypted);
        }
    };
    KeystoreAccess.prototype.onAuthenticationFailed = function () {
        this.promiseReject({
            code: keystore_access_common_1.ERROR_CODES.AUTHENTICATION_FAILED,
            message: "Finger not recognized"
        });
    };
    return KeystoreAccess;
}(android.hardware.fingerprint.FingerprintManager.AuthenticationCallback));
exports.KeystoreAccess = KeystoreAccess;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5c3RvcmUtYWNjZXNzLmFuZHJvaWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJrZXlzdG9yZS1hY2Nlc3MuYW5kcm9pZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUFzRDtBQUN0RCxtRUFBb0c7QUFFcEc7SUFBb0Msa0NBQXNFO0lBZXRHO1FBQUEsWUFDSSxpQkFBTyxTQUtWO1FBSkcsS0FBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDLHFCQUFxQixFQUFFLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDckYsSUFBSSxPQUFPLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxJQUFJLEVBQUUsRUFBRTtZQUN4QyxLQUFJLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3RJOztJQUNMLENBQUM7SUFFRCxrQ0FBUyxHQUFUO1FBQUEsaUJBOENDO1FBN0NHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQixPQUFPLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDL0IsSUFBSTtnQkFDQSxJQUFJLENBQUMsS0FBSSxDQUFDLGVBQWUsSUFBSSxDQUFDLEtBQUksQ0FBQyxlQUFlLENBQUMsZ0JBQWdCLEVBQUUsRUFBRTtvQkFDbkUsT0FBTyxDQUFDO3dCQUNKLEdBQUcsRUFBRSxLQUFLO3dCQUNWLFFBQVEsRUFBRSxJQUFJO3FCQUNqQixDQUFDLENBQUM7b0JBQ0gsT0FBTztpQkFDVjtnQkFFRCxJQUFJLE9BQU8sQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsRUFBRSxFQUFFO29CQUN2QyxPQUFPLENBQUM7d0JBQ0osR0FBRyxF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LENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQyxzQkFBc0IsR0F3U3pHO0FBeFNZLHdDQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgdXRpbHMgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdXRpbHMvdXRpbHNcIjtcbmltcG9ydCB7QmlvbWV0cmljSURBdmFpbGFibGVSZXN1bHQsIEVSUk9SX0NPREVTLCBLZXlzdG9yZUFjY2Vzc0FwaX0gZnJvbSBcIi4va2V5c3RvcmUtYWNjZXNzLmNvbW1vblwiO1xuXG5leHBvcnQgY2xhc3MgS2V5c3RvcmVBY2Nlc3MgZXh0ZW5kcyBhbmRyb2lkLmhhcmR3YXJlLmZpbmdlcnByaW50LkZpbmdlcnByaW50TWFuYWdlci5BdXRoZW50aWNhdGlvbkNhbGxiYWNrIGltcGxlbWVudHMgS2V5c3RvcmVBY2Nlc3NBcGkge1xuICAgIHByaXZhdGUga2V5Z3VhcmRNYW5hZ2VyOiBhbnk7XG4gICAgcHJpdmF0ZSBmaW5nZXJwcmludE1hbmFnZXI6IGFueTtcbiAgICBwcml2YXRlIGtleXN0b3JlS2V5QWxpYXM6IHN0cmluZztcbiAgICBwcml2YXRlIGRhdGE6IHN0cmluZztcbiAgICBwcml2YXRlIGtleVN0b3JlOiBqYXZhLnNlY3VyaXR5LktleVN0b3JlO1xuICAgIHByaXZhdGUgY2lwaGVyOiBqYXZheC5jcnlwdG8uQ2lwaGVyO1xuICAgIHByaXZhdGUgY3J5cHRvT2JqZWN0OiBhbmRyb2lkLmhhcmR3YXJlLmZpbmdlcnByaW50LkZpbmdlcnByaW50TWFuYWdlci5DcnlwdG9PYmplY3Q7XG4gICAgcHJpdmF0ZSBjaXBoZXJJbkVuY3J5cHRNb2RlOiBib29sZWFuO1xuICAgIHByaXZhdGUgZW5jcnlwdGlvbkl2OiBhbnk7XG4gICAgcHJpdmF0ZSBjYW5jZWxsYXRpb25TaWduYWw6IGFuZHJvaWQub3MuQ2FuY2VsbGF0aW9uU2lnbmFsO1xuXG4gICAgcHJpdmF0ZSBwcm9taXNlUmVzb2x2ZTsvLyBVc2VkIGZvciBhc3luYy9jYWxsYmFjayBmcm9tIEZpbmdlcnByaW50TWFuYWdlciwgY2FuIGJlIG92ZXJ3cml0dGVuIHNvIGRvbid0IGJlIGEgZm9vbCB3aXRoIGl0XG4gICAgcHJpdmF0ZSBwcm9taXNlUmVqZWN0Oy8vIFVzZWQgZm9yIGFzeW5jL2NhbGxiYWNrIGZyb20gRmluZ2VycHJpbnRNYW5hZ2VyLCBjYW4gYmUgb3ZlcndyaXR0ZW4gc28gZG9uJ3QgYmUgYSBmb29sIHdpdGggaXRcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLmtleWd1YXJkTWFuYWdlciA9IHV0aWxzLmFkLmdldEFwcGxpY2F0aW9uQ29udGV4dCgpLmdldFN5c3RlbVNlcnZpY2UoXCJrZXlndWFyZFwiKTtcbiAgICAgICAgaWYgKGFuZHJvaWQub3MuQnVpbGQuVkVSU0lPTi5TREtfSU5UID49IDIzKSB7XG4gICAgICAgICAgICB0aGlzLmZpbmdlcnByaW50TWFuYWdlciA9IHV0aWxzLmFkLmdldEFwcGxpY2F0aW9uQ29udGV4dCgpLmdldFN5c3RlbVNlcnZpY2UoYW5kcm9pZC5oYXJkd2FyZS5maW5nZXJwcmludC5GaW5nZXJwcmludE1hbmFnZXIuY2xhc3MpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXZhaWxhYmxlKCk6IFByb21pc2U8QmlvbWV0cmljSURBdmFpbGFibGVSZXN1bHQ+IHtcbiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7Ly8gU29tZWJvZHkgbWF5IGJlIGxpc3RlbmluZyBpbiwgYWx3YXlzIHN0b3AgbGlzdGVuaW5nIGJlZm9yZSBhbnl0aGluZyBlbHNlXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5rZXlndWFyZE1hbmFnZXIgfHwgIXRoaXMua2V5Z3VhcmRNYW5hZ2VyLmlzS2V5Z3VhcmRTZWN1cmUoKSkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFueTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21VSTogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBUaGUgZmluZ2VycHJpbnQgQVBJIGlzIG9ubHkgYXZhaWxhYmxlIGZyb20gQW5kcm9pZCA2LjAgKE0sIEFwaSBsZXZlbCAyMylcbiAgICAgICAgICAgICAgICBpZiAoYW5kcm9pZC5vcy5CdWlsZC5WRVJTSU9OLlNES19JTlQgPCAyMykge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFueTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICByZWFzb246IFwiWW91ciBhcGkgdmVyc2lvbiBkb2Vzbid0IHN1cHBvcnQgZmluZ2VycHJpbnQgYXV0aGVudGljYXRpb25cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbVVJOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5maW5nZXJwcmludE1hbmFnZXIuaXNIYXJkd2FyZURldGVjdGVkKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gRGV2aWNlIGRvZXNuJ3Qgc3VwcG9ydCBmaW5nZXJwcmludCBhdXRoZW50aWNhdGlvblxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFueTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICByZWFzb246IFwiRGV2aWNlIGRvZXNuJ3Qgc3VwcG9ydCBmaW5nZXJwcmludCBhdXRoZW50aWNhdGlvblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tVUk6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5maW5nZXJwcmludE1hbmFnZXIuaGFzRW5yb2xsZWRGaW5nZXJwcmludHMoKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBVc2VyIGhhc24ndCBlbnJvbGxlZCBhbnkgZmluZ2VycHJpbnRzIHRvIGF1dGhlbnRpY2F0ZSB3aXRoXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgYW55OiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlYXNvbjogXCJVc2VyIGhhc24ndCBlbnJvbGxlZCBhbnkgZmluZ2VycHJpbnRzIHRvIGF1dGhlbnRpY2F0ZSB3aXRoXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21VSTogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFueTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdWNoOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3VzdG9tVUk6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgZmluZ2VycHJpbnQtYXV0aC5hdmFpbGFibGU6ICR7ZXh9YCk7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGV4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdXNlQ3VzdG9tVUkoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHN0b3JlRGF0YVdpdGhGaW5nZXJwcmludChrZXlzdG9yZUtleUFsaWFzOiBzdHJpbmcsIGRhdGE6IHN0cmluZywgYmlvbWV0cmljTWVzc2FnZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOy8vIFNvbWVib2R5IG1heSBiZSBsaXN0ZW5pbmcgaW4sIGFsd2F5cyBzdG9wIGxpc3RlbmluZyBiZWZvcmUgYW55dGhpbmcgZWxzZVxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wcm9taXNlUmVzb2x2ZSA9IHJlc29sdmU7XG4gICAgICAgICAgICB0aGlzLnByb21pc2VSZWplY3QgPSByZWplY3Q7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHRoaXMua2V5c3RvcmVLZXlBbGlhcyA9IGtleXN0b3JlS2V5QWxpYXM7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gZGF0YTtcbiAgICAgICAgICAgICAgICB0aGlzLmNpcGhlckluRW5jcnlwdE1vZGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlS2V5KGtleXN0b3JlS2V5QWxpYXMpO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRMaXN0ZW5pbmcoKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS50cmFjZShleCk7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWxldGVGaW5nZXJwcmludEVuY3J5cHRlZERhdGEoa2V5c3RvcmVLZXlBbGlhcyk7XG4gICAgICAgICAgICAgICAgcmVqZWN0KHtcbiAgICAgICAgICAgICAgICAgICAgY29kZTogRVJST1JfQ09ERVMuREVWRUxPUEVSX0VSUk9SLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBleC5tZXNzYWdlLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXRyaWV2ZURhdGFXaXRoRmluZ2VycHJpbnQoa2V5c3RvcmVLZXlBbGlhczogc3RyaW5nLCBiaW9tZXRyaWNQcm9tcHRNZXNzYWdlOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsvLyBTb21lYm9keSBtYXkgYmUgbGlzdGVuaW5nIGluLCBhbHdheXMgc3RvcCBsaXN0ZW5pbmcgYmVmb3JlIGFueXRoaW5nIGVsc2VcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMucHJvbWlzZVJlc29sdmUgPSByZXNvbHZlO1xuICAgICAgICAgICAgdGhpcy5wcm9taXNlUmVqZWN0ID0gcmVqZWN0O1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNpcGhlckluRW5jcnlwdE1vZGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLmtleXN0b3JlS2V5QWxpYXMgPSBrZXlzdG9yZUtleUFsaWFzO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRMaXN0ZW5pbmcoKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWxldGVGaW5nZXJwcmludEVuY3J5cHRlZERhdGEoa2V5c3RvcmVLZXlBbGlhcyk7XG4gICAgICAgICAgICAgICAgcmVqZWN0KHtcbiAgICAgICAgICAgICAgICAgICAgY29kZTogRVJST1JfQ09ERVMuREVWRUxPUEVSX0VSUk9SLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBleC5tZXNzYWdlLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBmaW5nZXJwcmludEVuY3J5cHRlZERhdGFFeGlzdHMoa2V5c3RvcmVLZXlBbGlhczogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOy8vIFNvbWVib2R5IG1heSBiZSBsaXN0ZW5pbmcgaW4sIGFsd2F5cyBzdG9wIGxpc3RlbmluZyBiZWZvcmUgYW55dGhpbmcgZWxzZVxuICAgICAgICB0aGlzLmtleXN0b3JlS2V5QWxpYXMgPSBrZXlzdG9yZUtleUFsaWFzO1xuICAgICAgICBjb25zdCBwcmVmZXJlbmNlcyA9IGFuZHJvaWQucHJlZmVyZW5jZS5QcmVmZXJlbmNlTWFuYWdlci5nZXREZWZhdWx0U2hhcmVkUHJlZmVyZW5jZXModXRpbHMuYWQuZ2V0QXBwbGljYXRpb25Db250ZXh0KCkpO1xuICAgICAgICByZXR1cm4gcHJlZmVyZW5jZXMuY29udGFpbnMoS2V5c3RvcmVBY2Nlc3MubmFtZSArIHRoaXMua2V5c3RvcmVLZXlBbGlhcyk7XG4gICAgfVxuXG4gICAgZGVsZXRlRmluZ2VycHJpbnRFbmNyeXB0ZWREYXRhKGtleXN0b3JlS2V5QWxpYXM6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsvLyBTb21lYm9keSBtYXkgYmUgbGlzdGVuaW5nIGluLCBhbHdheXMgc3RvcCBsaXN0ZW5pbmcgYmVmb3JlIGFueXRoaW5nIGVsc2VcbiAgICAgICAgdGhpcy5rZXlzdG9yZUtleUFsaWFzID0ga2V5c3RvcmVLZXlBbGlhcztcbiAgICAgICAgY29uc3QgcHJlZmVyZW5jZXMgPSBhbmRyb2lkLnByZWZlcmVuY2UuUHJlZmVyZW5jZU1hbmFnZXIuZ2V0RGVmYXVsdFNoYXJlZFByZWZlcmVuY2VzKHV0aWxzLmFkLmdldEFwcGxpY2F0aW9uQ29udGV4dCgpKTtcbiAgICAgICAgcHJlZmVyZW5jZXMuZWRpdCgpLnJlbW92ZShLZXlzdG9yZUFjY2Vzcy5uYW1lICsgdGhpcy5rZXlzdG9yZUtleUFsaWFzKS5hcHBseSgpO1xuICAgIH1cblxuICAgIGNsZWFudXAoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlS2V5KGtleXN0b3JlS2V5QWxpYXM6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy5rZXlTdG9yZSA9IGphdmEuc2VjdXJpdHkuS2V5U3RvcmUuZ2V0SW5zdGFuY2UoJ0FuZHJvaWRLZXlTdG9yZScpO1xuICAgICAgICAgICAgdGhpcy5rZXlTdG9yZS5sb2FkKG51bGwpO1xuICAgICAgICAgICAgY29uc3Qga2V5R2VuZXJhdG9yID0gamF2YXguY3J5cHRvLktleUdlbmVyYXRvci5nZXRJbnN0YW5jZShhbmRyb2lkLnNlY3VyaXR5LmtleXN0b3JlLktleVByb3BlcnRpZXMuS0VZX0FMR09SSVRITV9BRVMsICdBbmRyb2lkS2V5U3RvcmUnKTtcblxuICAgICAgICAgICAga2V5R2VuZXJhdG9yLmluaXQoXG4gICAgICAgICAgICAgICAgbmV3IGFuZHJvaWQuc2VjdXJpdHkua2V5c3RvcmUuS2V5R2VuUGFyYW1ldGVyU3BlYy5CdWlsZGVyKGtleXN0b3JlS2V5QWxpYXMsIGFuZHJvaWQuc2VjdXJpdHkua2V5c3RvcmUuS2V5UHJvcGVydGllcy5QVVJQT1NFX0VOQ1JZUFQgfCBhbmRyb2lkLnNlY3VyaXR5LmtleXN0b3JlLktleVByb3BlcnRpZXMuUFVSUE9TRV9ERUNSWVBUKVxuICAgICAgICAgICAgICAgICAgICAuc2V0QmxvY2tNb2RlcyhbYW5kcm9pZC5zZWN1cml0eS5rZXlzdG9yZS5LZXlQcm9wZXJ0aWVzLkJMT0NLX01PREVfQ0JDXSlcbiAgICAgICAgICAgICAgICAgICAgLnNldFVzZXJBdXRoZW50aWNhdGlvblJlcXVpcmVkKHRydWUpXG4gICAgICAgICAgICAgICAgICAgIC5zZXRVc2VyQXV0aGVudGljYXRpb25WYWxpZGl0eUR1cmF0aW9uU2Vjb25kcygzMClcbiAgICAgICAgICAgICAgICAgICAgLnNldEVuY3J5cHRpb25QYWRkaW5ncyhbYW5kcm9pZC5zZWN1cml0eS5rZXlzdG9yZS5LZXlQcm9wZXJ0aWVzLkVOQ1JZUFRJT05fUEFERElOR19QS0NTN10pXG4gICAgICAgICAgICAgICAgICAgIC5zZXRLZXlTaXplKDI1NilcbiAgICAgICAgICAgICAgICAgICAgLmJ1aWxkKClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBrZXlHZW5lcmF0b3IuZ2VuZXJhdGVLZXkoKTtcbiAgICAgICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgICAgICAgIGNvbnNvbGUudHJhY2UoZXgpO1xuICAgICAgICAgICAgdGhpcy5wcm9taXNlUmVqZWN0KHtcbiAgICAgICAgICAgICAgICBjb2RlOiBFUlJPUl9DT0RFUy5ERVZFTE9QRVJfRVJST1IsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogZXgubWVzc2FnZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0Q2lwaGVyKG1vZGU6IG51bWJlciwga2V5c3RvcmVLZXlBbGlhczogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLmtleVN0b3JlID0gamF2YS5zZWN1cml0eS5LZXlTdG9yZS5nZXRJbnN0YW5jZSgnQW5kcm9pZEtleVN0b3JlJyk7XG4gICAgICAgICAgICB0aGlzLmtleVN0b3JlLmxvYWQobnVsbCk7XG4gICAgICAgICAgICBjb25zdCBrZXkgPSB0aGlzLmtleVN0b3JlLmdldEtleShrZXlzdG9yZUtleUFsaWFzLCBudWxsKTtcbiAgICAgICAgICAgIHRoaXMuY2lwaGVyID0gamF2YXguY3J5cHRvLkNpcGhlci5nZXRJbnN0YW5jZShgJHthbmRyb2lkLnNlY3VyaXR5LmtleXN0b3JlLktleVByb3BlcnRpZXMuS0VZX0FMR09SSVRITV9BRVN9LyR7YW5kcm9pZC5zZWN1cml0eS5rZXlzdG9yZS5LZXlQcm9wZXJ0aWVzLkJMT0NLX01PREVfQ0JDfS8ke2FuZHJvaWQuc2VjdXJpdHkua2V5c3RvcmUuS2V5UHJvcGVydGllcy5FTkNSWVBUSU9OX1BBRERJTkdfUEtDUzd9YCk7XG4gICAgICAgICAgICB0aGlzLmNyeXB0b09iamVjdCA9IG5ldyBhbmRyb2lkLmhhcmR3YXJlLmZpbmdlcnByaW50LkZpbmdlcnByaW50TWFuYWdlci5DcnlwdG9PYmplY3QodGhpcy5jaXBoZXIpO1xuICAgICAgICAgICAgaWYgKG1vZGUgPT0gamF2YXguY3J5cHRvLkNpcGhlci5FTkNSWVBUX01PREUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNpcGhlci5pbml0KGphdmF4LmNyeXB0by5DaXBoZXIuRU5DUllQVF9NT0RFLCBrZXkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJlZmVyZW5jZXMgPSBhbmRyb2lkLnByZWZlcmVuY2UuUHJlZmVyZW5jZU1hbmFnZXIuZ2V0RGVmYXVsdFNoYXJlZFByZWZlcmVuY2VzKHV0aWxzLmFkLmdldEFwcGxpY2F0aW9uQ29udGV4dCgpKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXZTdHJpbmcgPSBwcmVmZXJlbmNlcy5nZXRTdHJpbmcoS2V5c3RvcmVBY2Nlc3MubmFtZSArIGtleXN0b3JlS2V5QWxpYXMgKyBcIl9lbmNyeXB0aW9uX2l2XCIsIG51bGwpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXZTdHJpbmcgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgamF2YVN0cmluZyA9IG5ldyBqYXZhLmxhbmcuU3RyaW5nKG5ldyBqYXZhLmxhbmcuU3RyaW5nQnVmZmVyKGl2U3RyaW5nKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVuY3J5cHRpb25JdiA9IGFuZHJvaWQudXRpbC5CYXNlNjQuZGVjb2RlKGphdmFTdHJpbmcuZ2V0Qnl0ZXMoXCJVVEYtOFwiKSwgYW5kcm9pZC51dGlsLkJhc2U2NC5ERUZBVUxUKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2lwaGVyLmluaXQoamF2YXguY3J5cHRvLkNpcGhlci5ERUNSWVBUX01PREUsIGtleSwgbmV3IGphdmF4LmNyeXB0by5zcGVjLkl2UGFyYW1ldGVyU3BlYyh0aGlzLmVuY3J5cHRpb25JdikpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9taXNlUmVqZWN0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IEVSUk9SX0NPREVTLkRFVkVMT1BFUl9FUlJPUixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiSVYgbm90IGZvdW5kIHdoaWxlIGRlY3J5cHRpbmcuXCIsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgICAgICAgIGNvbnNvbGUudHJhY2UoZXgpO1xuICAgICAgICAgICAgaWYgKGV4IGluc3RhbmNlb2YgYW5kcm9pZC5zZWN1cml0eS5rZXlzdG9yZS5LZXlQZXJtYW5lbnRseUludmFsaWRhdGVkRXhjZXB0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9taXNlUmVqZWN0KHtcbiAgICAgICAgICAgICAgICAgICAgY29kZTogRVJST1JfQ09ERVMuVEFNUEVSRURfV0lUSCxcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogZXguZ2V0TWVzc2FnZSgpLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb21pc2VSZWplY3Qoe1xuICAgICAgICAgICAgICAgICAgICBjb2RlOiBFUlJPUl9DT0RFUy5ERVZFTE9QRVJfRVJST1IsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGV4Lm1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHRyeUVuY3J5cHQoc2VjcmV0OiBqYXZhLmxhbmcuU3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLmVuY3J5cHRpb25JdiA9IHRoaXMuY2lwaGVyLmdldElWKCk7XG4gICAgICAgICAgICBjb25zdCBlbmNyeXB0ZWQgPSBuZXcgamF2YS5sYW5nLlN0cmluZyhhbmRyb2lkLnV0aWwuQmFzZTY0LmVuY29kZSh0aGlzLmNpcGhlci5kb0ZpbmFsKHNlY3JldC5nZXRCeXRlcyhcIlVURi04XCIpKSwgYW5kcm9pZC51dGlsLkJhc2U2NC5ERUZBVUxUKSwgXCJVVEYtOFwiKS50b1N0cmluZygpO1xuICAgICAgICAgICAgY29uc3QgcHJlZmVyZW5jZXMgPSBhbmRyb2lkLnByZWZlcmVuY2UuUHJlZmVyZW5jZU1hbmFnZXIuZ2V0RGVmYXVsdFNoYXJlZFByZWZlcmVuY2VzKHV0aWxzLmFkLmdldEFwcGxpY2F0aW9uQ29udGV4dCgpKTtcbiAgICAgICAgICAgIC8vIFN0b3JlIElWIGFsb25nc2lkZSBlbmNyeXB0ZWQgZGF0YSBiZWNhdXNlIHdlIG5lZWQgaXQgZm9yIGRlY3J5cHRpb24uIElWIG1ha2VzIGl0IGhhcmRlciB0byBkZWNpcGhlciB0aGUgIGZvciBhIGhhY2tlciB3aXRoIGFjY2VzcyB0byB0aGUgZGV2aWNlIGRhdGFcbiAgICAgICAgICAgIGNvbnN0IGl2U3RyaW5nID0gbmV3IGphdmEubGFuZy5TdHJpbmcoYW5kcm9pZC51dGlsLkJhc2U2NC5lbmNvZGUodGhpcy5lbmNyeXB0aW9uSXYsIGFuZHJvaWQudXRpbC5CYXNlNjQuREVGQVVMVCksIFwiVVRGLThcIikudG9TdHJpbmcoKTtcbiAgICAgICAgICAgIHByZWZlcmVuY2VzLmVkaXQoKS5wdXRTdHJpbmcoS2V5c3RvcmVBY2Nlc3MubmFtZSArIHRoaXMua2V5c3RvcmVLZXlBbGlhcywgZW5jcnlwdGVkKS5wdXRTdHJpbmcoS2V5c3RvcmVBY2Nlc3MubmFtZSArIHRoaXMua2V5c3RvcmVLZXlBbGlhcyArIFwiX2VuY3J5cHRpb25faXZcIiwgaXZTdHJpbmcpLmFwcGx5KCk7XG4gICAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICBjb25zb2xlLnRyYWNlKGV4KTtcbiAgICAgICAgICAgIHRoaXMucHJvbWlzZVJlamVjdCh7XG4gICAgICAgICAgICAgICAgY29kZTogRVJST1JfQ09ERVMuREVWRUxPUEVSX0VSUk9SLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGV4Lm1lc3NhZ2UsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgdHJ5RGVjcnlwdCgpOiBzdHJpbmcge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcHJlZmVyZW5jZXMgPSBhbmRyb2lkLnByZWZlcmVuY2UuUHJlZmVyZW5jZU1hbmFnZXIuZ2V0RGVmYXVsdFNoYXJlZFByZWZlcmVuY2VzKHV0aWxzLmFkLmdldEFwcGxpY2F0aW9uQ29udGV4dCgpKTtcbiAgICAgICAgICAgIGNvbnN0IHNiID0gbmV3IGphdmEubGFuZy5TdHJpbmdCdWZmZXIocHJlZmVyZW5jZXMuZ2V0U3RyaW5nKEtleXN0b3JlQWNjZXNzLm5hbWUgKyB0aGlzLmtleXN0b3JlS2V5QWxpYXMsIFwiXCIpKTtcbiAgICAgICAgICAgIGNvbnN0IHNlY3JldCA9IGFuZHJvaWQudXRpbC5CYXNlNjQuZGVjb2RlKG5ldyBqYXZhLmxhbmcuU3RyaW5nKHNiKS5nZXRCeXRlcyhcIlVURi04XCIpLCBhbmRyb2lkLnV0aWwuQmFzZTY0LkRFRkFVTFQpO1xuICAgICAgICAgICAgY29uc3QgZGVjcnlwdGVkID0gdGhpcy5jaXBoZXIuZG9GaW5hbChzZWNyZXQpO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBqYXZhLmxhbmcuU3RyaW5nKGRlY3J5cHRlZCwgXCJVVEYtOFwiKS50b1N0cmluZygpO1xuICAgICAgICB9IGNhdGNoIChleCkge1xuICAgICAgICAgICAgY29uc29sZS50cmFjZShleCk7XG4gICAgICAgICAgICB0aGlzLnByb21pc2VSZWplY3Qoe1xuICAgICAgICAgICAgICAgIGNvZGU6IEVSUk9SX0NPREVTLkRFVkVMT1BFUl9FUlJPUixcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBleC5tZXNzYWdlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGFydExpc3RlbmluZygpIHtcbiAgICAgICAgdGhpcy5jYW5jZWxsYXRpb25TaWduYWwgPSBuZXcgYW5kcm9pZC5vcy5DYW5jZWxsYXRpb25TaWduYWwoKTtcbiAgICAgICAgdGhpcy5maW5nZXJwcmludE1hbmFnZXIuYXV0aGVudGljYXRlKHRoaXMuY3J5cHRvT2JqZWN0LCB0aGlzLmNhbmNlbGxhdGlvblNpZ25hbCwgMCAvKiBmbGFncyAqLywgdGhpcywgbnVsbCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdG9wTGlzdGVuaW5nKCkge1xuICAgICAgICBpZiAodGhpcy5jYW5jZWxsYXRpb25TaWduYWwgIT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5jYW5jZWxsYXRpb25TaWduYWwuY2FuY2VsKCk7XG4gICAgICAgICAgICB0aGlzLmNhbmNlbGxhdGlvblNpZ25hbCA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBGaW5nZXJwcmludE1hbmFnZXIuQXV0aGVudGljYXRpb25DYWxsYmFjayBjYWxsYmFja3NcblxuICAgIHB1YmxpYyBvbkF1dGhlbnRpY2F0aW9uRXJyb3IoZXJyb3JDb2RlOiBudW1iZXIsIGVyclN0cmluZzogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMucHJvbWlzZVJlamVjdCh7XG4gICAgICAgICAgICBjb2RlOiBFUlJPUl9DT0RFUy5BVVRIRU5USUNBVElPTl9GQUlMRUQsXG4gICAgICAgICAgICBtZXNzYWdlOiBlcnJTdHJpbmcsXG4gICAgICAgICAgICBlcnJvckNvZGU6IGVycm9yQ29kZVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25BdXRoZW50aWNhdGlvbkhlbHAoaGVscENvZGU6IG51bWJlciwgaGVscFN0cmluZzogc3RyaW5nKSB7XG4gICAgICAgIGlmIChoZWxwQ29kZSA9PSAxKSB7XG4gICAgICAgICAgICB0aGlzLnByb21pc2VSZWplY3Qoe1xuICAgICAgICAgICAgICAgIGNvZGU6IEVSUk9SX0NPREVTLlJFQ09WRVJBQkxFX0VSUk9SX0ZJTkdFUl9NVVNUX0NPVkVSX1NFTlNPUixcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBoZWxwU3RyaW5nXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIGlmIChoZWxwQ29kZSA9PSA1KSB7XG4gICAgICAgICAgICB0aGlzLnByb21pc2VSZWplY3Qoe1xuICAgICAgICAgICAgICAgIGNvZGU6IEVSUk9SX0NPREVTLlJFQ09WRVJBQkxFX0VSUk9SX0ZJTkdFUl9NT1ZFRF9UT19GQVNULFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGhlbHBTdHJpbmdcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wcm9taXNlUmVqZWN0KHtcbiAgICAgICAgICAgICAgICBjb2RlOiBFUlJPUl9DT0RFUy5SRUNPVkVSQUJMRV9FUlJPUl9CSU9NRVRSSUNTX05PVF9SRUNPR05JWkVELFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGhlbHBTdHJpbmdcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgb25BdXRoZW50aWNhdGlvblN1Y2NlZWRlZChyZXN1bHQ6IGFuZHJvaWQuaGFyZHdhcmUuZmluZ2VycHJpbnQuRmluZ2VycHJpbnRNYW5hZ2VyLkF1dGhlbnRpY2F0aW9uUmVzdWx0KSB7XG4gICAgICAgIGlmICh0aGlzLmNpcGhlckluRW5jcnlwdE1vZGUpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdENpcGhlcihqYXZheC5jcnlwdG8uQ2lwaGVyLkVOQ1JZUFRfTU9ERSwgdGhpcy5rZXlzdG9yZUtleUFsaWFzKTtcbiAgICAgICAgICAgIHRoaXMudHJ5RW5jcnlwdChuZXcgamF2YS5sYW5nLlN0cmluZyh0aGlzLmRhdGEpKTtcbiAgICAgICAgICAgIHRoaXMucHJvbWlzZVJlc29sdmUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdENpcGhlcihqYXZheC5jcnlwdG8uQ2lwaGVyLkRFQ1JZUFRfTU9ERSwgdGhpcy5rZXlzdG9yZUtleUFsaWFzKTtcbiAgICAgICAgICAgIGNvbnN0IGRlY3J5cHRlZCA9IHRoaXMudHJ5RGVjcnlwdCgpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coZGVjcnlwdGVkKTtcbiAgICAgICAgICAgIHRoaXMucHJvbWlzZVJlc29sdmUoZGVjcnlwdGVkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBvbkF1dGhlbnRpY2F0aW9uRmFpbGVkKCkge1xuICAgICAgICB0aGlzLnByb21pc2VSZWplY3Qoe1xuICAgICAgICAgICAgY29kZTogRVJST1JfQ09ERVMuQVVUSEVOVElDQVRJT05fRkFJTEVELFxuICAgICAgICAgICAgbWVzc2FnZTogXCJGaW5nZXIgbm90IHJlY29nbml6ZWRcIlxuICAgICAgICB9KTtcbiAgICB9XG5cbn0iXX0=